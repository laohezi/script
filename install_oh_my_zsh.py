#!/usr/bin/env python3
import subprocess
import os
import sys
import platform
from pathlib import Path

def run_cmd(cmd, check=True):
    print(f"æ‰§è¡Œå‘½ä»¤: {cmd}")
    try:
        subprocess.run(cmd, shell=True, check=check, executable='/bin/zsh')
        print(f"âœ… å‘½ä»¤æ‰§è¡ŒæˆåŠŸ")
        return True
    except subprocess.CalledProcessError as e:
        print(f"âŒ å‘½ä»¤æ‰§è¡Œå¤±è´¥: {cmd}")
        print(f"é”™è¯¯è¯¦æƒ…: {str(e)}")
        return False

def install_zsh():
    print("\n========== å¼€å§‹å®‰è£… ZSH ==========")
    system = platform.system()
    if system == "Darwin":
        if not Path("/bin/zsh").exists() and not Path("/opt/homebrew/bin/zsh").exists():
            print("ğŸ” æœªæ£€æµ‹åˆ° ZSHï¼Œé€šè¿‡ Homebrew å®‰è£…ä¸­...")
            result = run_cmd("brew install zsh")
            if result:
                print("âœ… ZSH å®‰è£…æˆåŠŸ")
            else:
                print("âŒ ZSH å®‰è£…å¤±è´¥")
        else:
            print("âœ… å·²æ£€æµ‹åˆ° ZSHï¼Œè·³è¿‡å®‰è£…")
    elif system == "Linux":
        if not Path("/bin/zsh").exists():
            print("ğŸ” æœªæ£€æµ‹åˆ° ZSHï¼Œé€šè¿‡ APT å®‰è£…ä¸­...")
            result = run_cmd("sudo apt update && sudo apt install -y zsh")
            if result:
                print("âœ… ZSH å®‰è£…æˆåŠŸ")
            else:
                print("âŒ ZSH å®‰è£…å¤±è´¥")
        else:
            print("âœ… å·²æ£€æµ‹åˆ° ZSHï¼Œè·³è¿‡å®‰è£…")
    else:
        print("âŒ ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ")
        sys.exit(1)

    # Set zsh as default shell
    current_shell = os.environ.get('SHELL', '')
    if 'zsh' not in current_shell:
        print("ğŸ”„ è®¾ç½® ZSH ä¸ºé»˜è®¤ shell...")
        result = run_cmd(f"chsh -s $(which zsh)", check=False)
        if result:
            print("âœ… å·²å°† ZSH è®¾ç½®ä¸ºé»˜è®¤ shell")
        else:
            print("âš ï¸ è®¾ç½®é»˜è®¤ shell å¯èƒ½éœ€è¦é‡æ–°ç™»å½•åç”Ÿæ•ˆ")
    else:
        print("âœ… ZSH å·²æ˜¯é»˜è®¤ shell")
    
    print("========== ZSH å®‰è£…å®Œæˆ ==========")

def install_ohmyzsh():
    print("\n========== å¼€å§‹å®‰è£… Oh My ZSH ==========")
    ohmyzsh_dir = Path.home() / ".oh-my-zsh"
    if not ohmyzsh_dir.exists():
        print("ğŸ”„ æ­£åœ¨å®‰è£… Oh My ZSH...")
        result = run_cmd('sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended')
        if result:
            print("âœ… Oh My ZSH å®‰è£…æˆåŠŸ")
        else:
            print("âŒ Oh My ZSH å®‰è£…å¤±è´¥")
    else:
        print("âœ… å·²æ£€æµ‹åˆ° Oh My ZSHï¼Œè·³è¿‡å®‰è£…")
    
    print("========== Oh My ZSH å®‰è£…å®Œæˆ ==========")

def install_plugins():
    print("\n========== å¼€å§‹å®‰è£…æ’ä»¶ ==========")
    plugins_dir = Path.home() / ".oh-my-zsh/custom/plugins"
    plugins = {
        "zsh-syntax-highlighting": "https://github.com/zsh-users/zsh-syntax-highlighting.git",
        "zsh-history-substring-search": "https://github.com/zsh-users/zsh-history-substring-search.git",
        "zsh-completions": "https://github.com/zsh-users/zsh-completions.git",
        "zsh-autosuggestions": "https://github.com/zsh-users/zsh-autosuggestions.git"
    }

    total_plugins = len(plugins)
    installed_plugins = 0
    
    print(f"ğŸ”„ å…±è®¡ {total_plugins} ä¸ªæ’ä»¶å¾…å®‰è£…")
    
    for plugin, url in plugins.items():
        plugin_path = plugins_dir / plugin
        if not plugin_path.exists():
            print(f"\nğŸ“¦ å®‰è£…æ’ä»¶ ({installed_plugins+1}/{total_plugins}): {plugin}")
            result = run_cmd(f"git clone {url} {plugin_path}")
            if result:
                print(f"âœ… æ’ä»¶ {plugin} å®‰è£…æˆåŠŸ")
                installed_plugins += 1
            else:
                print(f"âŒ æ’ä»¶ {plugin} å®‰è£…å¤±è´¥")
        else:
            print(f"âœ… æ’ä»¶ {plugin} å·²å­˜åœ¨ï¼Œè·³è¿‡å®‰è£…")
            installed_plugins += 1
    
    print(f"\nâœ… æˆåŠŸå®‰è£… {installed_plugins}/{total_plugins} ä¸ªæ’ä»¶")
    print("========== æ’ä»¶å®‰è£…å®Œæˆ ==========")

def update_zshrc():
    print("\n========== å¼€å§‹æ›´æ–°é…ç½®æ–‡ä»¶ ==========")
    zshrc = Path.home() / ".zshrc"
    backup = zshrc.with_suffix('.zshrc.bak')
    
    # Create backup
    if zshrc.exists() and not backup.exists():
        print(f"ğŸ”„ åˆ›å»ºé…ç½®æ–‡ä»¶å¤‡ä»½: {backup}")
        zshrc.rename(backup)
        print("âœ… å¤‡ä»½åˆ›å»ºæˆåŠŸ")
    elif backup.exists():
        print(f"â„¹ï¸ å¤‡ä»½æ–‡ä»¶å·²å­˜åœ¨: {backup}")

    # Generate new config
    print("ğŸ”„ ç”Ÿæˆæ–°çš„é…ç½®æ–‡ä»¶...")
    config = f"""# Generated by install script
export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="robbyrussell"

plugins=(
    git
    zsh-syntax-highlighting
    zsh-history-substring-search
    zsh-completions
    zsh-autosuggestions
)

source $ZSH/oh-my-zsh.sh

# Plugin configurations
ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE="fg=#888888"
bindkey '^[[A' history-substring-search-up
bindkey '^[[B' history-substring-search-down
"""

    # Preserve custom configurations from backup
    if backup.exists():
        print("ğŸ”„ åˆå¹¶ç”¨æˆ·è‡ªå®šä¹‰é…ç½®...")
        try:
            with open(backup, 'r') as f:
                content = f.read()
                custom = content.split('# Generated by install script', 1)[0]
                if custom.strip():
                    print("âœ… å·²ä¿ç•™ç”¨æˆ·è‡ªå®šä¹‰é…ç½®")
                    config = custom + config
        except Exception as e:
            print(f"âš ï¸ è¯»å–å¤‡ä»½æ–‡ä»¶æ—¶å‡ºé”™: {str(e)}")

    try:
        with open(zshrc, 'w') as f:
            f.write(config)
        print(f"âœ… é…ç½®æ–‡ä»¶å·²æ›´æ–°: {zshrc}")
    except Exception as e:
        print(f"âŒ å†™å…¥é…ç½®æ–‡ä»¶å¤±è´¥: {str(e)}")
    
    print("========== é…ç½®æ–‡ä»¶æ›´æ–°å®Œæˆ ==========")

if __name__ == "__main__":
    print("\nğŸš€ å¼€å§‹å®‰è£… Oh My ZSH åŠæ’ä»¶...")
    print("======================================")
    
    install_zsh()
    install_ohmyzsh()
    install_plugins()
    update_zshrc()
    
    print("\n======================================")
    print("âœ¨ å®‰è£…å®Œæˆ!")
    print("ğŸ“ æ‘˜è¦:")
    print("  - ZSH å·²å®‰è£…")
    print("  - Oh My ZSH æ¡†æ¶å·²å®‰è£…")
    print("  - å·²å®‰è£…æ’ä»¶: git, zsh-syntax-highlighting, zsh-history-substring-search, zsh-completions, zsh-autosuggestions")
    print("  - é…ç½®æ–‡ä»¶å·²æ›´æ–°")
    print("\nâš ï¸ è¯·é‡å¯ç»ˆç«¯æˆ–æ‰§è¡Œ 'source ~/.zshrc' ä»¥åº”ç”¨æ›´æ”¹")
    print("ğŸ‘‰ å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥å¤‡ä»½æ–‡ä»¶: ~/.zshrc.bak")
    print("======================================\n")
